#!/usr/bin/env ruby

def test(repeats = 1000)
	mutex = Mutex.new
	
	mutexes = {}
	threads = []
	
	threads = repeats.times.map do |i|
		Thread.new do
			mutexes[i] ||= Mutex.new
		end
	end
	
	threads.each(&:join)
	
	missing = repeats.times.to_a - mutexes.keys
	
	if threads.size != mutexes.size or missing.any?
		puts "There were #{threads.size} threads and #{mutexes.size} mutexes."
		puts "Missing: #{missing.inspect}"
		
		binding.irb
	end
end

100.times{test}
