#!/usr/bin/env ruby

@mutex = Mutex.new
@queue = Hash.new{|h,k| h[k] = []}

def add(item)
	@queue[Thread.current.object_id] << item
end

def flush
	@mutex.synchronize do
		total = 0
		
		@queue[Thread.current.object_id].each do |item|
			total += item
		end
		
		@queue.delete(Thread.current.object_id)
		
		return total
	end
end

threads = []

100.times do
	threads << Thread.new do
		while true
			100.times do
				add(1)
			end
			
			total = flush
			
			if total != 100
				puts "#{total} != 100"
			end
		end
	end
end

threads.each(&:join)
