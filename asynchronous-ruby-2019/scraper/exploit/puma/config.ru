
require 'rack'

require 'async'
require 'async/http/internet'

class Recursive
	def initialize
	end
	
	def call(env)
		request = Rack::Request.new(env)
		ttl = Integer(request.params['ttl']) rescue 10
		
		return [200, [], ["Hello World"]] if ttl.zero?
		
		Async do
			internet = Async::HTTP::Internet.new
			
			response = internet.get("http://localhost:9292/hello?ttl=#{ttl-1}")
			
			[response.status, response.headers, [response.read, "!"]]
		ensure
			internet.close
		end.wait
	end
end

run Recursive.new