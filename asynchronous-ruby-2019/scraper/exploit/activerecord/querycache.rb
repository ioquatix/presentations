#!/usr/bin/env ruby

require 'active_record'

ActiveRecord::Base.establish_connection("postgres://localhost/rubygems")

base = ActiveRecord::Base
threads = []

puts "0 Query cache enabled? #{base.connection.query_cache_enabled}"

threads << Thread.new do
	puts "1 Query cache enabled? #{base.connection.query_cache_enabled}"
	base.cache do
		puts "2 Query cache enabled? #{base.connection.query_cache_enabled}"
		sleep 1
	end
	puts "3 Query cache enabled? #{base.connection.query_cache_enabled}"
end

threads << Thread.new do
	puts "4 Query cache enabled? #{base.connection.query_cache_enabled}"
	sleep 0.1
	puts "5 Query cache enabled? #{base.connection.query_cache_enabled}"
	base.cache do
		puts "6 Query cache enabled? #{base.connection.query_cache_enabled}"
		sleep 2
		puts "7 Query cache enabled? #{base.connection.query_cache_enabled}"
	end
	puts "8 Query cache enabled? #{base.connection.query_cache_enabled}"
end

threads.each(&:join)

puts "9 Query cache enabled? #{base.connection.query_cache_enabled}"
