#!/usr/bin/env ruby

gem "money"
require 'money/rates_store/memory'

mutex = Mutex.new
store = Money::RatesStore::Memory.new

threads = []

expected_rate = 1.5

1000.times do
	threads << Thread.new do
		while true
			currency1 = ("A".ord..."Z".ord).to_a.sample(3).map(&:chr).join
			currency2 = ("A".ord..."Z".ord).to_a.sample(3).map(&:chr).join
			rate = nil
			
			# puts "Adding rate #{currency1} -> #{currency2}"
			store.add_rate(currency1, currency2, expected_rate)
			rate = store.get_rate(currency1, currency2)
			
			if rate != expected_rate
				puts "Rate #{rate.inspect} != #{expected_rate.inspect}"
			end
		end
	end
end

threads.each(&:join)
