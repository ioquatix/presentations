#!/usr/bin/env ruby

require 'rspec'
require 'rspec/core/memoized_helpers'

@cache = RSpec::Core::MemoizedHelpers::ThreadsafeMemoized.new

@threads = []
@items = []

def update(key)
	10.times do
		@threads << Thread.new do |thread|
			@cache.fetch_or_store(key) do
				sleep(0.1)
				
				puts "Updating cache: #{key}"
				@items << key
				
				"is awesome"
			end
		end
	end
end

100.times do |i|
	update("thing-#{i}")
end

@threads.each(&:join)

pp @items.size
